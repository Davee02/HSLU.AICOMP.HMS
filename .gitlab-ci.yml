---
image: python:3.11.9-bullseye

variables:
    PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"

# Pip's cache doesn't store the python packages
# https://pip.pypa.io/en/stable/topics/caching/
#
# If you want to also cache the installed packages, you have to install
# them in a virtualenv and cache it as well.
cache:
    paths:
        - .cache/pip
        - venv/


before_script:
    - pip install --upgrade pip
    - pip install -r requirements_ci.txt

stages:
    - test

test_code:
    stage: test
    script:
        - coverage run -m pytest tests --junitxml=report.xml --ignore=tests/integration_tests
        - coverage report --include=src/* --omit=tmp/*
        - coverage xml --include=src/* --omit=tmp/*
    coverage: '/TOTAL\s+\d+\s+\d+\s+(\d+%)/'
    artifacts:
        when: always
        paths:
            - ./*.xml
        reports:
            junit: report.xml
            coverage_report:
                coverage_format: cobertura
                path: coverage.xml
    cache:
        untracked: false
